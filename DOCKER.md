# Docker Deployment Guide

## Multi-Pod Architecture (Recommended)

This deployment uses separate containers for the client and server with proper package exports.

### Architecture

- **Client**: Nginx serving the static Vite build with runtime server URL injection
- **Server**: Node.js running Colyseus game server with proper ES module support
- **Shared**: TypeScript package with proper exports configuration for module resolution

### Module Resolution

The project uses proper npm package exports in the shared package to ensure TypeScript path aliases are correctly resolved in both local development and Docker:

```json
{
  "exports": {
    ".": "./dist/src/index.js",
    "./types": "./dist/src/types.js",
    "./engine/GameClock": "./dist/src/engine/GameClock.js",
    "./engine/GameEngine": "./dist/src/engine/GameEngine.js",
    "./engine/PhysicsEngine": "./dist/src/engine/PhysicsEngine.js",
    "./engine/types": "./dist/src/engine/types.js",
    "./utils/geometry": "./dist/src/utils/geometry.js"
  }
}
```

The server imports from the shared package using `@kickoff/shared/*` syntax:

```typescript
import { gameClock } from '@kickoff/shared/engine/GameClock'
import { GAME_CONFIG } from '@kickoff/shared/types'
import { GameEngine } from '@kickoff/shared/engine/GameEngine'
```

TypeScript's `bundler` moduleResolution setting properly resolves these imports:

```json
{
  "compilerOptions": {
    "moduleResolution": "bundler"
  }
}
```

### Quick Start

```bash
# Build and start all services
docker-compose -f docker-compose.multi-pod.yml up --build

# Or with custom ports
CLIENT_PORT=8080 SERVER_PORT=3001 docker-compose -f docker-compose.multi-pod.yml up --build

# Stop all services
docker-compose -f docker-compose.multi-pod.yml down
```

### Environment Variables

**Client:**
- `SERVER_URL` - Server WebSocket URL (defaults to `http://localhost:3000`)
- `CLIENT_PORT` - Host port for client (defaults to `80`)

**Server:**
- `PORT` - Internal server port (defaults to `3000`, mapped via `SERVER_PORT`)
- `CORS_ORIGIN` - Allowed CORS origins (comma-separated, defaults to `*`)
- `SERVER_PORT` - Host port for server (defaults to `3000`)

### Runtime Configuration

The client build is statically generated by Vite, but the server URL is injected at container startup time via `client-entrypoint.sh`. This allows deploying the same client image with different server configurations without rebuilding:

```bash
# The entrypoint script injects:
<meta name="server-url" content="${WS_URL}">
<script>window.__SERVER_URL__='${WS_URL}';</script>
```

The `MultiplayerScene` checks these runtime values before falling back to build-time environment variables.

### Network Configuration

The deployment uses a custom Docker network with IPv6 support:

```yaml
networks:
  socca2-network:
    driver: bridge
    enable_ipv6: true
    ipam:
      config:
        - subnet: fd00::/80
```

Both containers are configured to listen on `::` (IPv6 dual-stack mode).

### Health Checks

**Client:**
```bash
curl http://localhost:8080/health
# Returns: healthy
```

**Server:**
```bash
curl http://localhost:3001/health
# Returns: {"status":"ok","timestamp":...,"server":"Kickoff v0.2.0"}
```

### File Structure

```
Socca2/
├── docker-compose.multi-pod.yml    # Orchestration config
├── Dockerfile.client               # Client build (nginx)
├── Dockerfile.server               # Server build (node)
├── docker/
│   ├── nginx-client.conf          # Nginx config for SPA routing
│   └── client-entrypoint.sh       # Runtime URL injection
├── client/                        # Vite frontend
├── server/                        # Colyseus backend
└── shared/                        # Shared game logic with exports
```

### Production Deployment

1. **Set production environment variables:**
   ```bash
   export SERVER_URL=wss://your-server.com
   export CORS_ORIGIN=https://your-client.com
   ```

2. **Build and deploy:**
   ```bash
   docker-compose -f docker-compose.multi-pod.yml up -d --build
   ```

3. **Verify health:**
   ```bash
   curl https://your-client.com/health
   curl https://your-server.com/health
   ```

### Troubleshooting

**Module resolution errors:**
- Ensure `shared/package.json` has proper `exports` field
- Verify `server/tsconfig.json` uses `moduleResolution: "bundler"`
- Check that all relative imports within `shared` use `.js` extensions

**Connection issues:**
- Check `SERVER_URL` environment variable in client container
- Verify WebSocket URL protocol (ws:// or wss://)
- Confirm CORS settings allow your client origin

**Build failures:**
- Clear Docker cache: `docker-compose -f docker-compose.multi-pod.yml build --no-cache`
- Check `.dockerignore` isn't excluding required files
- Verify all workspace dependencies are installed

### Development vs Production

**Development:**
- Uses local `npm run dev` with hot-reload
- Server on `localhost:3000`, client on `localhost:5173`
- No Docker required

**Production (Docker):**
- Optimized multi-stage builds
- Minimal Alpine images
- Runtime configuration injection
- Health monitoring
- IPv6 support

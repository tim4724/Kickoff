name: Preview Cleanup

on:
  delete:
    branches:
      - '**'

jobs:
  cleanup:
    runs-on: [self-hosted, k8s]
    if: github.event.ref_type == 'branch'
    steps:
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.30.0

      - name: Write kubeconfig
        run: |
          echo "${KUBECONFIG_B64}" | base64 -d > kubeconfig
          echo "KUBECONFIG=$PWD/kubeconfig" >> "$GITHUB_ENV"
        env:
          KUBECONFIG_B64: ${{ secrets.KUBECONFIG_B64 }}

      - name: Delete preview namespace
        run: |
          set -euo pipefail
          BRANCH_RAW="${{ github.event.ref }}"
          # Convert to lowercase, replace invalid chars with hyphens
          SAFE_BRANCH=$(echo "$BRANCH_RAW" | tr '[:upper:]' '[:lower:]' | sed 's#[^a-z0-9-]#-#g')
          # Truncate to 54 chars (must match preview.yml logic)
          SAFE_BRANCH=$(echo "$SAFE_BRANCH" | cut -c1-54)
          # Remove trailing hyphens after truncation
          SAFE_BRANCH=$(echo "$SAFE_BRANCH" | sed 's#-*$##')
          NS="kickoff-${SAFE_BRANCH}"
          kubectl delete namespace "$NS" --ignore-not-found

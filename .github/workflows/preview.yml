name: Preview Deploy

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

permissions:
  contents: read
  packages: write
  pull-requests: write

env:
  REGISTRY: ghcr.io/${{ github.repository_owner }}
  IMAGE_CLIENT: ghcr.io/${{ github.repository_owner }}/kickoff-client
  IMAGE_SERVER: ghcr.io/${{ github.repository_owner }}/kickoff-server

jobs:
  build:
    uses: ./.github/workflows/docker-publish.yml
    secrets: inherit
    permissions:
      contents: read
      packages: write
      id-token: write

  deploy:
    runs-on: [self-hosted, k8s]
    needs: build
    steps:
      - name: Checkout (for manifests/templates if needed)
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.30.0

      - name: Write kubeconfig
        run: |
          echo "${KUBECONFIG_B64}" | base64 -d > kubeconfig
          echo "KUBECONFIG=$PWD/kubeconfig" >> "$GITHUB_ENV"
        env:
          KUBECONFIG_B64: ${{ secrets.KUBECONFIG_B64 }}

      - name: Deploy preview to Kubernetes
        env:
          BRANCH_RAW: ${{ github.ref_name }}
          CLIENT_IMAGE: ${{ needs.build.outputs.client_sha_tag }}
          SERVER_IMAGE: ${{ needs.build.outputs.server_sha_tag }}
        run: |
          set -euo pipefail
          SAFE_BRANCH=$(echo "$BRANCH_RAW" | tr '[:upper:]' '[:lower:]' | sed 's#[^a-z0-9-]#-#g')
          NS="kickoff-${SAFE_BRANCH}"
          HOST_CLIENT="${SAFE_BRANCH}.kickoff-game.duckdns.org"
          HOST_SERVER="server-${SAFE_BRANCH}.kickoff-game.duckdns.org"

          kubectl get ns "$NS" >/dev/null 2>&1 || kubectl create ns "$NS"

          TLS_CRT=$(kubectl get secret kickoff-game-wildcard-tls -n default -o jsonpath='{.data.tls\.crt}')
          TLS_KEY=$(kubectl get secret kickoff-game-wildcard-tls -n default -o jsonpath='{.data.tls\.key}')

          cat <<EOS | kubectl apply -n "$NS" -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: kickoff-game-wildcard-tls
          type: kubernetes.io/tls
          data:
            tls.crt: ${TLS_CRT}
            tls.key: ${TLS_KEY}
          EOS

          cat <<EOF | kubectl apply -n "$NS" -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: kickoff-client
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: kickoff-client
            template:
              metadata:
                labels:
                  app: kickoff-client
              spec:
                containers:
                  - name: kickoff-client
                    image: ${CLIENT_IMAGE}
                    env:
                      - name: SERVER_URL
                        value: wss://${HOST_SERVER}
                    ports:
                      - containerPort: 8080
                        name: http
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: kickoff-client
          spec:
            selector:
              app: kickoff-client
            ports:
              - port: 8080
                targetPort: 8080
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: kickoff-server
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: kickoff-server
            template:
              metadata:
                labels:
                  app: kickoff-server
              spec:
                containers:
                  - name: kickoff-server
                    image: ${SERVER_IMAGE}
                    ports:
                      - containerPort: 3000
                        name: http
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: kickoff-server
          spec:
            selector:
              app: kickoff-server
            ports:
              - port: 3000
                targetPort: 3000
          ---
          apiVersion: traefik.io/v1alpha1
          kind: Middleware
          metadata:
            name: redirect-to-https
          spec:
            redirectScheme:
              scheme: https
              permanent: true
          ---
          apiVersion: traefik.io/v1alpha1
          kind: IngressRoute
          metadata:
            name: kickoff-client-https
          spec:
            entryPoints:
              - websecure
            routes:
              - match: Host(\`${HOST_CLIENT}\`)
                kind: Rule
                services:
                  - name: kickoff-client
                    port: 8080
            tls:
              secretName: kickoff-game-wildcard-tls
          ---
          apiVersion: traefik.io/v1alpha1
          kind: IngressRoute
          metadata:
            name: kickoff-server-https
          spec:
            entryPoints:
              - websecure
            routes:
              - match: Host(\`${HOST_SERVER}\`)
                kind: Rule
                services:
                  - name: kickoff-server
                    port: 3000
            tls:
              secretName: kickoff-game-wildcard-tls
          ---
          apiVersion: traefik.io/v1alpha1
          kind: IngressRoute
          metadata:
            name: kickoff-client-http
          spec:
            entryPoints:
              - web
            routes:
              - match: Host(\`${HOST_CLIENT}\`)
                kind: Rule
                services:
                  - name: kickoff-client
                    port: 8080
                middlewares:
                  - name: redirect-to-https
          ---
          apiVersion: traefik.io/v1alpha1
          kind: IngressRoute
          metadata:
            name: kickoff-server-http
          spec:
            entryPoints:
              - web
            routes:
              - match: Host(\`${HOST_SERVER}\`)
                kind: Rule
                services:
                  - name: kickoff-server
                    port: 3000
                middlewares:
                  - name: redirect-to-https
          EOF

      - name: Publish preview URLs
        env:
          BRANCH_RAW: ${{ github.ref_name }}
        run: |
          SAFE_BRANCH=$(echo "$BRANCH_RAW" | tr '[:upper:]' '[:lower:]' | sed 's#[^a-z0-9-]#-#g')
          HOST_CLIENT="${SAFE_BRANCH}.kickoff-game.duckdns.org"
          {
            echo "### Preview Links"
            echo "- Client: https://${HOST_CLIENT}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Comment preview URL on PR
        if: false
        run: echo "PR commenting handled by separate job."

  comment:
    runs-on: ubuntu-latest
    needs: deploy
    if: ${{ github.event_name == 'pull_request' && needs.deploy.result == 'success' }}
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Post preview URL comment (if PR exists)
        env:
          BRANCH_RAW: ${{ github.head_ref }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_API_URL: ${{ github.api_url }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: |
          SAFE_BRANCH=$(echo "$BRANCH_RAW" | tr '[:upper:]' '[:lower:]' | sed 's#[^a-z0-9-]#-#g')
          HOST_CLIENT="${SAFE_BRANCH}.kickoff-game.duckdns.org"
          PR_JSON=$(curl -s -H "Authorization: Bearer ${GITHUB_TOKEN}" \
                         "${GITHUB_API_URL}/repos/${GITHUB_REPOSITORY}/pulls?head=${GITHUB_REPOSITORY_OWNER}:${BRANCH_RAW}&state=open")
          PR_NUMBER=$(echo "$PR_JSON" | python3 -c "import json,sys; data=json.load(sys.stdin); print(data[0]['number'] if data else '')")
          if [ -z "$PR_NUMBER" ]; then
            echo "No open PR for branch ${BRANCH_RAW}; skipping comment."
            exit 0
          fi
          BODY="Preview available: https://${HOST_CLIENT}"
          curl -s -H "Authorization: Bearer ${GITHUB_TOKEN}" \
               -H "Content-Type: application/json" \
               -X POST \
               -d "{\"body\":\"${BODY}\"}" \
               "${GITHUB_API_URL}/repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/comments"
